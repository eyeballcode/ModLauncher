group 'com.eyeball'

defaultTasks 'calcVersion'

buildscript {
    repositories {
        maven {
            url 'https://plugins.gradle.org/m2/'
        }
    }
    dependencies {
    }
}

apply plugin: 'java'

def getVersionID() {
    def revision = 'git rev-list --count HEAD'.execute().text.trim()
    def hash = 'git rev-parse --short HEAD'.execute().text.trim()
    def version = "git.rev$revision.$hash"
    return version
}

task calcVersion << {
    println "Running build ${getVersionID()}"
}

task genJava() {
    println "Generating ${projectDir}/src/main/java/com/eyeball/modlauncher/build/BuildInfo.java"
    def bi = new File("${projectDir}/src/main/java/com/eyeball/modlauncher/build/BuildInfo.java")
    bi.write("package com.eyeball.modlauncher.build;\n")
    bi << "public class BuildInfo {\n"
    bi << "    public static final String VERSION = \"${getVersionID()}\";\n"
    bi << "}"
}

jar {
    manifest {
        attributes("Implementation-Title": project.name,
                "Implementation-Version": getVersionID(),
                "Main-Class": "com.eyeball.modlauncher.ModLauncher")
    }
}

archivesBaseName = "ModLauncher-${getVersionID()}"
